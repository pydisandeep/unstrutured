import os
import json
from docx import Document
from docx.table import Table
from docx.text.paragraph import Paragraph

def iter_block_items(parent):
    """Yield paragraphs and tables in document order."""
    for child in parent.element.body:
        if child.tag.endswith('p'):
            yield Paragraph(child, parent)
        elif child.tag.endswith('tbl'):
            yield Table(child, parent)


def docx_to_ordered_json(docx_path):
    doc = Document(docx_path)
    output = []

    for block in iter_block_items(doc):
        if isinstance(block, Paragraph):
            output.append({
                "type": "paragraph",
                "text": block.text.strip()
            })

        elif isinstance(block, Table):
            rows = []
            for row in block.rows:
                rows.append([cell.text.strip() for cell in row.cells])
            output.append({
                "type": "table",
                "rows": rows
            })

    return output


# ---- MAIN ----
docx_file = "input.docx"

result = docx_to_ordered_json(docx_file)

# Get directory + filename
directory = os.path.dirname(docx_file)
basename = os.path.splitext(os.path.basename(docx_file))[0]

# JSON file path (same directory)
json_path = os.path.join(directory, f"{basename}.json")

# Save JSON
with open(json_path, "w", encoding="utf-8") as f:
    json.dump(result, f, ensure_ascii=False, indent=4)

print(f"Saved JSON to: {json_path}")
